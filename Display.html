<html>

<head>

  <script>
    var ws = new WebSocket("ws://localhost:3000/");

    let name = "";
    let con_right = false;
    let con_left = false;
    let con_right_position = "";
    let con_left_position = "";
    let con_right_c = false;
    let con_left_c = false;

    function start() {
      canv = document.getElementById("gc"); // canvas wird geladen
      ctx = canv.getContext("2d"); //modus auf 2d setzen

      setInterval(game, 1000 / 120); // Wiederholung von der function game 120 mal in der Sekunde ( 120 fps)
      canv.width = window.innerWidth - 50;
      canv.height = window.innerHeight - 50;
      var punkte_schläger_right = 0;
      var punkte_schläger_left = 0;
      var start_game = false;




      function makeFigur(x_pos, y_pos, höhe, breite) {
        this.x = x_pos;
        this.y = y_pos; // Position (x, y)
        this.höhe = höhe;
        this.breite = breite;
        this.vx = 0;
        this.vy = 0; // Geschwindigkeit in x bzw. y-Richtung



        this.move = function() {
          // Figur bewegen und dann für ein Frame anzeigen
          this.x = this.x + this.vx;
          this.y = this.y + this.vy;
          ctx.fillStyle = "white";
          ctx.fillRect(this.x, this.y, this.höhe, this.breite);
        }
      }


      var ball = new makeFigur(60, canv.height / 2, 10, 10);
      var schläger_right = new makeFigur(canv.width - 10, canv.height / 2 - 25, 10, 50);
      var schläger_left = new makeFigur(0, canv.height / 2 - 25, 10, 50);


      console.log(canv.width);


      ball.vy = (Math.random() * 2) + -2;

      ball.vx = canv.width / 467, 5;

      function game() {
        //websocket
        //if(con_right_c){
        if (con_right_position == "up") {
          schläger_right.y -= 10;
          console.log("Right up");
          con_right_position = "";
          start_game = true;
        } else if (con_right_position == "down") {
          schläger_right.y += 10;
          console.log("right down");
          con_right_position = "";
          start_game = true;
        }
        //  }else if (con_left_c) {
        else if (con_left_position == "up") {
          schläger_left.y -= 10;
          console.log("Left up");
          con_left_position = "";
          start_game = true;
        } else if (con_left_position == "down") {
          schläger_left.y += 10;
          console.log("Left down");
          con_left_position = "";
          start_game = true;
        }
        //}
        // zeichnet alle Lienien
        ctx.fillStyle = "black";
        ctx.fillRect(0, 0, canv.width, canv.height);
        ctx.fillStyle = "#20872f";
        ctx.fillRect(0, 0, canv.width, 10);
        ctx.fillRect(0, canv.height - 10, canv.width, 10);
        ctx.fillStyle = "#c42d00";
        ctx.fillRect(0, 0, 10, canv.height);
        ctx.fillRect(canv.width - 10, 0, 10, canv.height);
        ctx.fillStyle = "#595d6d";
        ctx.fillRect(canv.width / 2 - 5, 0, 10, canv.height);
        //

        // zeigt punkte an
        ctx.font = "bold 68px Keania One";
        ctx.fillStyle = 'white';
        ctx.textBaseline = 'top';
        ctx.fillText(punkte_schläger_left, canv.width / 2 - 100, canv.height / 2 - 20);
        ctx.fillText(punkte_schläger_right, canv.width / 2 + 50, canv.height / 2 - 20);
        //

        // bewegt alles
        if (start_game) {
          ball.move();
        } else {
          ctx.fillRect(ball.x, ball.y, ball.höhe, ball.breite);
        }
        schläger_right.move();
        schläger_left.move();
        //

        if (ball.y >= canv.height - 20 || ball.y <= 20) { // ball springt von Seitenbanden ab
          ball.vy = -ball.vy;
        }


        if (ball.x > canv.width - 15 && ball.x <= canv.width - 5 && ball.y > schläger_right.y && ball.y < schläger_right.y + 50) { // schaut ob der rechte schläger den Ball trifft
          ball.vx = -ball.vx; // spring vom Schläger ab
        }

        if (ball.x < 15 && ball.x <= 5 && ball.y > schläger_left.y && ball.y < schläger_left.y + 50) { // schaut ob der linke schläger den Ball trifft
          ball.vx = -ball.vx; // spring vom Schläger ab
        }

        // stoppt die Banden beim aus dem Bild gehen
        if (schläger_right.y < 0) {
          schläger_right.y = 0;
        } else if (schläger_right.y + 50 > canv.height) {
          schläger_right.y = canv.height - 50;
        }


        if (schläger_left.y < 0) {
          schläger_left.y = 0;
        } else if (schläger_left.y + 50 > canv.height) {
          schläger_left.y = canv.height - 50;
        }
        //

        // punkt prüfung
        if (ball.x > canv.width) {
          punkte_schläger_left++;
          ball.vx = -canv.width / 467, 5;
          ball.x = canv.width - 70;
          ball.vy = (Math.random() * 4) + -4;

          ball.y = canv.height / 2;
          schläger_right.y = schläger_left.y = canv.height / 2 - 25;
          start_game = false;




        }
        if (ball.x < 0) {
          punkte_schläger_right++;

          ball.vx = canv.width / 467, 5;
          ball.x = 60;
          ball.vy = (Math.random() * 4) + -4;

          ball.y = canv.height / 2;
          schläger_right.y = schläger_left.y = canv.height / 2 - 25;
          start_game = false;

        }
        //
      }

      //
    }

    function load() {

      if ("WebSocket" in window) {
        //alert("WebSocket is supported by your Browser!");

        // Let us open a web socket


        ws.onopen = function() {
          console.log("Connected");
          ws.send(JSON.stringify({
            id: "Display"
          }));
          // Web Socket is connected, send data using send()

          //alert("Message is sent...");
        };

        ws.onmessage = function(evt) {
          let data = evt.data;
          console.log(data);
          let obj = JSON.parse(data);
          switch (obj.id) {
            case "LOGIN":
              name = obj.name;
              console.log(name);
              document.getElementById("name").innerHTML = "Enter the Code on the Contoller: " + name;

            case "CONTROLLER CONNECT":
              if (obj.orien == "_right") {
                con_right = true;
              } else if (obj.orien == "_left") {
                con_left = true;
              }
              if (con_right && con_left) {
                document.getElementById("name").innerHTML = "Both Controller are connected. Game starts in 5 seconds";
                document.getElementById('name').style.display = "none";
                document.getElementById("gc").style.display = "inline-block";
                document.getElementById("font").style.display = "inline-block";
                console.log("dd");
                ws.send(JSON.stringify({
                  id: "GO",
                  name: name

                }))
                /*  sleep(1000);
                document.getElementById("name").innerHTML = "Both Controller are connected. Game starts in 4 seconds";
                sleep(1000);

                document.getElementById("name").innerHTML = "Both Controller are connected. Game starts in 3 seconds";
                sleep(1000);

                document.getElementById("name").innerHTML = "Both Controller are connected. Game starts in 2 seconds";
                sleep(1000);

                document.getElementById("name").innerHTML = "Both Controller are connected. Game starts in 1 second";
                sleep(1000);
*/
                start();
              } else if (con_right) {
                document.getElementById("name").innerHTML = "Waiting for the left Controller.    Code:" + name;
              } else if (con_right) {
                document.getElementById("name").innerHTML = "Waiting for the right Controller.     Code:" + name;
              }
              break;
            case "GAME":
              if (con_right && con_left) {
                if (obj.orien == "_right") {
                  con_right_c = true;
                  con_right_position = obj.y;
                  con_right_c = false;

                } else if (obj.orien == "_left") {
                  con_left_c = true;
                  con_left_position = obj.y;
                  con_left_c = false;

                }
              }
              break;

          } //switch
        };

        ws.onclose = function() {

          // websocket is closed.
          console.log("connection ends");

        };
      } else {

        // The browser doesn't support WebSocket
        alert("WebSocket NOT supported by your Browser!");
      }
    }
  </script>

</head>




<body onload="load();">
  <p><span id="name" style="display:inline-block"></span></p>
  <span style="font-family: 'Keania+One';" style="display:none" id="font"> &nbsp; </span>

  <canvas id="gc" width="" height="" style="display:none"></canvas>



</body>

</html>
